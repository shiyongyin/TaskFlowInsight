# TaskFlow Insight — M2 PRD（产品需求文档）

**版本**: v2.0.0  
**负责人**: 产品团队  
**状态**: 正式版  
**日期**: 2025-01-10  

---

## 1. 背景与目标

**一句话定位**: TaskFlow Insight M2 阶段聚焦「对象变更追踪」能力构建，实现业务流程中数据状态变化的全程可视化与审计。

**M2 主题**: ChangeTracking — 通过零侵入的属性变更捕获、对比、审计、回放能力，让业务数据的每一次变化都有迹可循，为问题诊断、合规审计、性能优化提供强力支撑。

## 2. 范围与边界

### In-Scope（M2 包含）
- ✅ 对象属性变更追踪（注解驱动 + 编程API）
- ✅ 字段级 Diff 检测（支持嵌套深度 5 层）
- ✅ 变更事件模型与关联（与任务节点自动关联）
- ✅ 基础查询与检索（按对象/字段/时间/用户）
- ✅ 变更时间线可视化（HTML 报告集成）
- ✅ 审计日志导出（JSON/CSV/Markdown）
- ✅ Spring Boot Starter 集成
- ✅ 与现有任务树深度集成

### Out-of-Scope（M2 不包含）
- ❌ 跨系统分布式变更追踪
- ❌ 统一权限中心
- ❌ 复杂多租户计费模型
- ❌ 跨语言 Agent（仅 Java）
- ❌ 实时流处理（Kafka/Flink）
- ❌ AI 驱动的异常检测

## 3. 用户画像与关键场景

| 角色 | 核心诉求 | 关键场景 | M2 价值点 |
|------|---------|---------|-----------|
| **开发工程师** | 快速定位数据异常 | 调试时追踪对象状态变化 | 一行注解即可追踪，变更自动关联到任务节点 |
| **技术经理** | 了解系统数据流向 | 代码评审时理解数据变更逻辑 | 完整的变更审计链，Who-What-When-Where-Why |
| **运维工程师** | 故障根因分析 | 生产问题排查时回溯数据状态 | 时间旅行能力，查看任意时刻的对象状态 |
| **业务分析师** | 理解业务流程 | 分析订单状态转换 | 可视化变更时间线，业务语义清晰 |
| **合规审计师** | 满足审计要求 | 敏感数据操作审计 | 完整的审计日志，支持多格式导出 |

## 4. 需求列表

| ID | 优先级 | 描述 | 业务动机 | 验收标准（量化） |
|----|--------|------|----------|------------------|
| R01 | Must | 对象属性变更追踪API | 核心能力基础 | 4个核心API可用，响应时间<10ms |
| R02 | Must | 字段级变更检测 | 精确定位变化 | 支持5层嵌套，准确率>99% |
| R03 | Must | 变更与任务节点关联 | 流程可追溯 | 100%变更记录包含nodeId/sessionId |
| R04 | Must | Spring Boot 注解支持 | 降低使用门槛 | @TrackChanges注解可用，零配置启动 |
| R05 | Should | 变更查询API | 灵活检索 | 支持5种查询维度，响应<200ms@1k记录 |
| R06 | Should | 历史状态回放 | 时间旅行调试 | 可查询任意时刻状态，准确率100% |
| R07 | Should | HTML报告集成 | 可视化展示 | 变更时间线嵌入现有报告 |
| R08 | Should | 审计日志导出 | 合规需求 | 支持JSON/CSV/MD三种格式 |
| R09 | Could | 批量追踪优化 | 性能优化 | 批量操作性能提升>50% |
| R10 | Could | 变更通知机制 | 实时感知 | 支持变更事件订阅 |

## 5. 非功能需求

| 维度 | 指标 | 目标值 | 优先级 |
|------|------|--------|--------|
| **性能** | 追踪开销 | <5% CPU/内存增量 | P0 |
| **性能** | 变更检测延迟 | <10ms/对象 | P0 |
| **性能** | 查询响应时间 | <200ms@10k记录 | P1 |
| **可靠性** | 系统可用性 | 99.9% | P0 |
| **可靠性** | 数据准确性 | 100%（无丢失） | P0 |
| **安全性** | 敏感数据处理 | 支持字段级脱敏 | P1 |
| **可用性** | 集成时间 | <10分钟 | P0 |
| **可维护性** | 代码覆盖率 | >80% | P1 |

## 6. 成功指标（KPI/北极星）

### 技术指标
- 日追踪对象数：>100万
- 日变更记录数：>1000万  
- P95 检测延迟：<20ms
- 内存占用增量：<100MB/10k对象

### 业务指标
- 问题定位时间：减少70%（从小时到分钟）
- 审计合规率：100%覆盖
- 开发接入成本：<30分钟
- 用户满意度：>85%

## 7. 里程碑与交付

| 里程碑 | 范围 | 核心交付 | 验收标准 |
|--------|------|----------|----------|
| **M2-M0（MVP）** | 基础追踪能力 | • 4个核心API<br>• 简单反射实现<br>• 基础变更检测 | • 单元测试100%通过<br>• Demo可运行<br>• 代码<500行 |
| **M2-M1（Balanced）** | 完整追踪系统 | • 完整查询API<br>• 历史回放<br>• Spring集成<br>• Who-Why上下文 | • 集成测试通过<br>• 性能基准达标<br>• 文档完整 |
| **M2-M2（Systematization）** | 生产级品质 | • 持久化存储<br>• 监控规则引擎<br>• HTML报告集成<br>• 性能优化 | • 压测10k TPS通过<br>• 生产环境验证<br>• 0 P0缺陷 |

## 8. 风险 & 对策

| 风险类型 | 描述 | 概率 | 影响 | 缓解措施 |
|---------|------|------|------|----------|
| **性能风险** | 反射操作导致性能下降 | 中 | 高 | 1. 缓存反射元数据<br>2. 采样率控制<br>3. 异步处理 |
| **内存风险** | 大量追踪对象导致OOM | 中 | 高 | 1. LRU缓存策略<br>2. 自动清理机制<br>3. 内存阈值保护 |
| **兼容性风险** | Spring版本兼容问题 | 低 | 中 | 1. 多版本测试<br>2. 条件化配置<br>3. 降级方案 |
| **复杂度风险** | 嵌套对象处理复杂 | 中 | 中 | 1. 深度限制（5层）<br>2. 循环引用检测<br>3. 简化值存储 |

## 9. 术语表（Glossary）

| 术语 | 定义 | 说明 |
|------|------|------|
| **ChangeRecord** | 变更记录 | 记录单个字段的变化，包含old/new值及完整上下文 |
| **ObjectSnapshot** | 对象快照 | 某时刻对象的状态快照，用于变更检测 |
| **TrackingContext** | 追踪上下文 | 线程级的追踪环境，管理追踪对象和变更 |
| **ChangeType** | 变更类型 | CREATE/UPDATE/DELETE三种变更类型 |
| **ObjectState** | 对象状态 | 对象在特定时刻的完整字段值集合 |

## 10. 追溯表（需求 → API/序列/存储）

| 需求ID | API | 核心类 | 存储 | 序列图 |
|--------|-----|--------|------|--------|
| R01 | TFI.track() | ChangeTracker | ThreadLocal | 追踪初始化流程 |
| R02 | TFI.getChanges() | DiffDetector | Map<String,Object> | 变更检测流程 |
| R03 | - | TaskNode集成 | Session关联 | 任务关联流程 |
| R04 | @TrackChanges | TrackChangesAspect | - | AOP拦截流程 |
| R05 | TFI.queryChanges() | ChangeQuery | List<ChangeRecord> | 查询执行流程 |
| R06 | TFI.getStateAt() | ObjectState | 历史记录 | 状态重建流程 |
| R07 | exportHtml() | HtmlReporter | - | 报告生成流程 |
| R08 | ChangeExporter | - | File/Stream | 导出流程 |

---

**文档版本历史**

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 2.0.0 | 2025-01-10 | PM/SA | 基于源码分析重建M2 PRD |
| 1.0.0 | 2025-01-09 | 产品团队 | 初始版本 |