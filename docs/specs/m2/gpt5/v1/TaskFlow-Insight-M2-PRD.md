Title: TaskFlow Insight — M2 PRD
Version/Owner/Status/Date
- Version: v2.0.0-M2
- Owner: PM/SA (联合维护)
- Status: Draft (based on code evidence)
- Date: 2025-09-10

1. 背景与目标
- 定位：TaskFlow Insight（TFI）以“任务树 + 执行流程洞察 + 变更跟踪”为核心。M2 主题为 ChangeTracking：对象变更捕获/对比/审计/回放/与任务树联动，补足 PRD 中“变更追踪是未被满足的需求”。
- 目标：在不破坏既有核心引擎的前提下，引入低开销、可插拔的变更追踪最小闭环，并逐步演进至可审计、可查询、可回放的体系能力。

2. 范围与边界
- In-Scope（M2）
  - 变更捕获接入：显式 API（必选），注解/AOP（M1 起）。
  - 字段级 Diff：标量/基础类型为主，集合/Map 在 M1 增强，嵌套深度受限（默认≤2）。
  - 策略与扩展：Diff/脱敏/白名单 SPI（M1 起）。
  - 事件模型与持久化：内存事件存储（M0），本地文件（M1，可选），外部存储适配点（M2）。
  - 基础检索与时间线：按对象/字段/时间段检索（M1），回放轨迹（M2）。
  - 审计导出：Console/JSON（M0），文件滚动与归档（M1）。
  - 与任务树/指标联动：在任务节点下汇总变更条目（M0），统计聚合（M1）。
- Out-of-Scope（M2）
  - 跨系统一致性、统一权限中心、复杂多租计费、跨语言 Agent。

3. 用户画像与关键场景
- Java 后端开发：定位业务异常，追溯“何时/何地/何值被修改”。
- 架构师/性能工程师：观察关键对象在关键路径上的状态演化，与耗时热点关联。
- 审计/合规辅助：导出变更流水（本地 JSON/文本）以满足审计取证（非强一致）。

4. 需求列表
| ID | Must/Should | 描述 | 业务动机 | 验收标准（量化） |
|---|---|---|---|---|
| M2-F001 | Must | 显式变更追踪 API（track/trackAll/getChanges/clearAllTracking） | 最小代价接入 | 通过 API 用例：对 2 个字段修改，getChanges 返回 2 条差异；P95 开销 ≤ 3%（单对象≤20字段） |
| M2-F002 | Must | 字段级 Diff：标量/字符串/日期 | 可读可比对 | 在 100 次变更检测中，正确率 100%；不抛异常；单次检测耗时 ≤ 200μs@2字段 |
| M2-F003 | Must | 与任务树联动：变更汇入当前 TaskNode 消息（CHANGE） | 一屏观测 | Console/JSON 导出包含变更段，且对应 TaskNode 路径正确 |
| M2-F004 | Should | 集合/Map 简单变更（新增/删除/替换判定） | 贴近业务常见结构 | 针对 List 增删改各 20 次，检测准确率 ≥ 95% |
| M2-F005 | Should | 脱敏与白名单（字段名模式） | 降低隐私风险 | 命中脱敏规则字段输出“***”；不在白名单的字段不采集 |
| M2-F006 | Should | 基础检索与时间线（内存） | 事后分析 | 可按对象名/字段/时间段过滤；1k 条目内检索 ≤ 50ms |
| M2-F007 | Should | 审计导出（JSON/文本） | 合规与共享 | 生成按 sessionId/时间命名的 JSON；文件大小控制与滚动策略（配置） |
| M2-F008 | Should | 注解/AOP 接入（@TrackChanges/参数 @Track） | 降低改造成本 | 样例服务中可用；禁用时零侵入；开销可控（≤5%） |
| M2-F009 | Should | 可插拔策略 SPI（Diff/脱敏/序列化） | 自定义与扩展 | 通过 ServiceLoader 注入自定义实现，冲突时按优先级选择 |
| M2-F010 | Should | 简单回放（同一对象的字段轨迹） | 还原演化过程 | 返回时间序列（timestamp, value）；窗口 1k 条 ≤ 100ms |

5. 非功能需求
- 性能：
  - 写路径：单对象≤20字段，track+一次 getChanges() P95 CPU 开销 ≤ 3%；M1 含集合 ≤ 5%。
  - 读路径：1k 条变更检索 ≤ 50ms；10k 条 ≤ 200ms。
- 可靠性：
  - 变更存储采用环形缓冲与逐会话清理；溢出时降级为仅消息记录，不中断主流程。
  - 异常隔离：变更追踪内部异常以日志告警，不传播至业务线程（参考现有 TFI.handleInternalError）。
- 安全：
  - 脱敏/白名单优先；配置默认关闭采集敏感字段；导出路径需显式配置。
  - 不向 Actuator 暴露敏感值（仅计数/统计）。
- 可用性/可维护性：
  - 5 分钟接入显式 API；注解通过 Starter 自动配置（M1）。
  - 单元/集成测试覆盖 ≥ 80%（变更追踪模块）。

6. 成功指标（KPI/北极星）
- Feature 采纳：示例项目/集成文档（≥2 篇）+ 仓库 Star 增长（+100）。
- 性能健康：基准测试报告通过上述性能阈值。
- 质量：变更检测覆盖常见类型场景；新增缺陷密度 < 5/KLOC。

7. 里程碑与交付
| 里程碑 | 范围 | 核心交付 | 验收标准 |
|---|---|---|---|
| M2-M0（MVP，2 周） | 显式 API、标量 Diff、与任务树联动、Console/JSON 导出 | 新增 API/内部快照与比对、控制台/JSON 集成、样例与测试 | 通过 M2-F001/F002/F003；性能阈值达标 |
| M2-M1（Balanced，3 周） | 集合/Map、脱敏/白名单、基础检索与时间线、注解/AOP | SPI 策略、内存索引、注解与切面、文件导出 | 通过 M2-F004/F005/F006/F007/F008/F009 |
| M2-M2（Systematization，3 周） | 简单回放、外部存储适配点、可视化联动增强 | 回放 API、持久化扩展接口、报告增强 | 通过 M2-F010，回放窗口性能达标 |

8. 风险 & 对策
- 反射读取与深度递归造成开销：限制字段数与深度；热路径缓存 Property 元数据；可禁用。
- 集合/Map Diff 复杂度：先支持“增/删/替换”三类；跳过复杂嵌套结构；SPIs 可替换。
- 内存占用与 OOM：环形缓冲+会话边界清理；超过阈值按配置降级为仅消息。
- 隐私与泄漏：默认脱敏+白名单，导出按需开启；Actuator 不输出具体值。

9. 术语表（Glossary）
- 变更记录（ChangeRecord）：一次字段值从旧到新的变更条目。
- 快照（Snapshot）：对象在某一时刻的字段取值集合（受白名单/深度限制）。
- 轨迹（Timeline）：同一对象/字段在时间轴上的值序列。
- 回放（Replay）：基于变更记录重建对象某字段的历史状态。
- 会话（Session）：TFI 的一次任务树收敛单位，对应现有 `Session`。

10. 追溯表（需求 → API/序列/存储）
| 需求ID | API/类 | 时序 | 存储 |
|---|---|---|---|
| M2-F001 | TODO: 在 `src/main/java/com/syy/taskflowinsight/api/TFI.java` 增加 `track/trackAll/getChanges/clearAllTracking` | 任务执行中 `TFI.track` 捕获初始快照；`TFI.stop` 或明确调用 `getChanges` 触发 Diff | M0：线程内存（ThreadLocal Map）；按会话清理 |
| M2-F002 | TODO: 内部 `ChangeTracker`/`ObjectSnapshot`（新增包 `changes`） | `capture(before)`→执行业务→`capture(after)`→`diff` | M0：仅内存，受字段/深度上限 |
| M2-F003 | 复用 `TaskNode.addMessage`（CHANGE）【src/main/java/com/syy/taskflowinsight/model/TaskNode.java#addMessage】 | `TFI.stop` 汇总变更写入 Message | 归属到当前 Session 的 TaskNode |
| M2-F004 | TODO: 集合/Map 处理策略（新增 SPI） | `diffCollection/diffMap` | 内存，仅摘要化存储 |
| M2-F005 | TODO: 脱敏/白名单配置（新增 `ChangeTrackingProperties`） | `filter → mask → store` | 仅保留脱敏后的值 |
| M2-F006 | TODO: 内存检索器（索引：对象名/字段/时间） | `query(object, field, range)` | 内存跳表/倒排（简化） |
| M2-F007 | TODO: 导出器（JSON/文本） | `export(sessionId)` | 本地文件；滚动与命名规范 |
| M2-F008 | TODO: 注解 `@TrackChanges`/参数 `@Track` + 切面 `ChangeTrackingAspect` | AOP 前后置快照 | 与现有 AutoConfiguration 对齐 |
| M2-F009 | TODO: SPI 扩展 | ServiceLoader 装配 | SPI 注册表 |
| M2-F010 | TODO: 回放 API | `replay(object, field, window)` | 时间序列缓存 |


**版本**: v2.0.0  
**日期**: 2025年1月  
**状态**: 正式版  
**作者**: 产品管理部  
**审核**: 技术委员会  

---

## 1. 执行摘要

### 1.1 产品定位升级

TaskFlow Insight M2 定位为**企业级智能流程监控与优化平台**，从M1的技术工具升级为业务赋能平台，通过深度流程洞察和智能分析，帮助企业实现：

- **业务流程可视化**：让复杂的业务流程一目了然
- **性能问题预防**：从事后诊断转向事前预防
- **智能优化建议**：基于数据驱动的优化决策
- **全链路追踪**：端到端的业务流程监控

### 1.2 核心价值主张

> "从代码执行的技术视角，升级为业务流程的管理视角"

**M1 → M2 价值演进**：
- 技术工具 → 业务平台
- 被动记录 → 主动监控
- 单点分析 → 全局优化
- 开发使用 → 全员参与

---

## 2. 市场分析与机遇

### 2.1 市场趋势

**数字化转型背景下的流程监控需求**

| 市场驱动因素 | 影响程度 | 机会描述 |
|------------|---------|---------|
| **微服务架构普及** | 高 | 复杂调用链需要可视化管理 |
| **DevOps文化** | 高 | 开发运维一体化需要统一监控 |
| **性能要求提升** | 高 | 毫秒级优化成为竞争优势 |
| **合规审计要求** | 中 | 业务流程需要可追溯可审计 |
| **AI技术成熟** | 中 | 智能分析和预测成为可能 |

### 2.2 竞争格局分析

**与主流产品的差异化定位**

| 竞品类型 | 代表产品 | 他们的优势 | 我们的差异化 |
|---------|---------|-----------|-------------|
| **APM平台** | Datadog, New Relic | 全栈监控 | 专注业务流程，更懂业务 |
| **日志平台** | ELK, Splunk | 海量数据处理 | 结构化流程，开箱即用 |
| **链路追踪** | Zipkin, Jaeger | 分布式追踪 | 业务语义，变更追踪 |
| **BI工具** | Tableau, PowerBI | 数据可视化 | 流程可视化，实时分析 |

**核心竞争优势**：
1. **业务导向**：不只是技术指标，更关注业务指标
2. **智能分析**：自动识别瓶颈，提供优化建议
3. **零侵入性**：注解驱动，对现有代码影响最小
4. **全员可用**：产品、运营、技术都能看懂

### 2.3 目标市场

**主要市场**：
- 金融科技企业（交易流程监控）
- 电商平台（订单流程优化）
- 物流企业（供应链追踪）
- 制造业（生产流程管理）

**市场规模**：
- TAM（总体市场）：全球流程监控市场 $50B
- SAM（可服务市场）：Java企业应用市场 $5B
- SOM（可获得市场）：国内中大型企业 $100M

---

## 3. 用户研究与洞察

### 3.1 用户角色矩阵

| 角色 | 核心诉求 | 使用场景 | 关键功能 |
|------|---------|---------|---------|
| **开发工程师** | 快速定位问题 | 调试、优化 | 代码级追踪、性能分析 |
| **技术经理** | 团队效率提升 | 代码审查、性能评估 | 瓶颈分析、趋势报告 |
| **产品经理** | 理解用户路径 | 功能优化、体验改进 | 流程可视化、用户行为 |
| **运维工程师** | 系统稳定性 | 故障排查、容量规划 | 实时监控、告警规则 |
| **业务分析师** | 流程优化 | 效率分析、成本优化 | 业务报表、对比分析 |
| **管理层** | 决策支持 | 战略规划、资源分配 | 仪表盘、ROI分析 |

### 3.2 用户旅程地图

**典型用户旅程：性能问题排查**

```
发现问题 → 定位范围 → 深入分析 → 找到根因 → 验证修复
   ↓          ↓          ↓          ↓          ↓
告警触发   查看流程图   钻取详情   变更追踪   对比分析
   5min      10min      15min      20min      25min
```

**痛点与机会**：
- **痛点1**：从告警到定位耗时过长 → **机会**：智能定位
- **痛点2**：需要多个工具配合 → **机会**：一站式平台
- **痛点3**：分析需要专业知识 → **机会**：智能建议

### 3.3 用户反馈洞察

基于M1版本的用户反馈：

**正面反馈**（保持优势）：
- "树形结构让复杂流程一目了然" - 开发者
- "终于知道时间都花在哪里了" - 技术经理
- "部署简单，5分钟就跑起来了" - 运维

**改进需求**（M2重点）：
- "希望能看到数据的变化过程" → 变更追踪
- "需要更漂亮的报告给老板看" → HTML报告
- "想要自动发现问题" → 智能监控
- "希望和Spring Boot深度集成" → Starter

---

## 4. 产品功能设计

### 4.1 功能架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户交互层                            │
│  ┌──────────┬──────────┬──────────┬──────────────────┐ │
│  │ Web控制台 │ HTML报告  │ API接口  │ 告警通知        │ │
│  └──────────┴──────────┴──────────┴──────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                    智能分析层                            │
│  ┌──────────┬──────────┬──────────┬──────────────────┐ │
│  │ 瓶颈识别  │ 趋势分析  │ 异常检测  │ 优化建议        │ │
│  └──────────┴──────────┴──────────┴──────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                    核心功能层                            │
│  ┌──────────┬──────────┬──────────┬──────────────────┐ │
│  │ 流程追踪  │ 变更监控  │ 性能分析  │ 规则引擎        │ │
│  └──────────┴──────────┴──────────┴──────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                    数据采集层                            │
│  ┌──────────┬──────────┬──────────┬──────────────────┐ │
│  │ 注解采集  │ AOP拦截   │ MDC注入   │ 自定义采集      │ │
│  └──────────┴──────────┴──────────┴──────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                    基础设施层                            │
│  ┌──────────┬──────────┬──────────┬──────────────────┐ │
│  │ 存储管理  │ 配置中心  │ 集群协调  │ 安全认证        │ │
│  └──────────┴──────────┴──────────┴──────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 4.2 核心功能模块

#### 4.2.1 智能变更追踪系统

**功能定位**：业务数据的"时光机"

**核心能力**：
- **多维追踪**：同时监控多个业务对象
- **深度感知**：追踪嵌套对象和集合变化
- **智能对比**：自动识别关键变更
- **追溯链路**：变更与执行步骤关联

**用户价值**：
- 快速定位数据异常的发生位置
- 理解业务状态的演变过程
- 支持问题回溯和审计需求

**成功指标**：
- 变更检测准确率 > 99%
- 性能开销 < 5%
- 支持对象深度 > 10层

#### 4.2.2 可视化报告中心

**功能定位**：让数据会说话的展示平台

**核心能力**：
- **交互式流程图**：支持缩放、筛选、钻取
- **性能热力图**：直观展示性能分布
- **时间轴视图**：时序化展示执行过程
- **智能标注**：自动标记异常和瓶颈

**报告类型**：
| 报告类型 | 目标用户 | 核心内容 | 输出格式 |
|---------|---------|---------|---------|
| 技术报告 | 开发者 | 详细执行树、性能指标 | HTML/JSON |
| 业务报告 | 产品/运营 | 流程图、关键指标 | HTML/PDF |
| 管理报告 | 管理层 | 趋势、对比、ROI | PDF/PPT |
| 实时大屏 | 运维中心 | 实时指标、告警 | Web/TV |

**差异化设计**：
- 一键生成，无需配置
- 多主题支持（亮色/暗色/高对比）
- 移动端自适应
- 支持离线查看

#### 4.2.3 智能监控引擎

**功能定位**：从被动响应到主动预防

**核心能力**：
- **规则引擎**：灵活的规则配置
- **智能基线**：自动学习正常模式
- **异常检测**：实时发现异常
- **根因分析**：自动分析问题原因

**规则类型**：
- 阈值规则（响应时间、错误率）
- 趋势规则（性能恶化、流量异常）
- 对比规则（环比、同比）
- 复合规则（多条件组合）

**告警分级**：
| 级别 | 场景 | 通知方式 | 响应要求 |
|------|------|---------|---------|
| P0-紧急 | 核心流程异常 | 电话+短信+邮件 | 5分钟 |
| P1-严重 | 性能严重下降 | 短信+邮件 | 30分钟 |
| P2-警告 | 性能轻微下降 | 邮件+站内信 | 2小时 |
| P3-提醒 | 潜在风险 | 站内信 | 24小时 |

#### 4.2.4 Spring生态深度集成

**功能定位**：无缝融入Spring生态系统

**集成方案**：
- **Spring Boot Starter**：零配置启动
- **Spring Cloud**：分布式追踪
- **Spring Security**：权限控制
- **Spring Actuator**：健康检查

**开发者体验**：
- 一行依赖引入
- 自动识别Spring组件
- 与Spring工具链集成
- IDE智能提示支持

### 4.3 用户体验设计

#### 4.3.1 设计原则

1. **渐进式复杂度**
   - 默认简单：开箱即用
   - 按需深入：高级功能可选
   - 学习曲线平缓

2. **视觉层次清晰**
   - 重要信息突出
   - 次要信息收起
   - 异常信息高亮

3. **交互直观自然**
   - 符合用户心智模型
   - 操作可撤销
   - 实时反馈

#### 4.3.2 信息架构

```
首页仪表盘
├── 实时监控
│   ├── 流程地图
│   ├── 性能指标
│   └── 告警列表
├── 历史分析
│   ├── 趋势分析
│   ├── 对比分析
│   └── 根因分析
├── 报告中心
│   ├── 自动报告
│   ├── 定制报告
│   └── 报告模板
└── 配置管理
    ├── 监控规则
    ├── 告警配置
    └── 系统设置
```

---

## 5. 数据指标体系

### 5.1 产品健康度指标

| 指标类别 | 核心指标 | 目标值 | 监控频率 |
|---------|---------|--------|---------|
| **采用度** | 日活跃用户(DAU) | 1000+ | 每日 |
| **活跃度** | 人均使用时长 | >30分钟 | 每周 |
| **满意度** | NPS评分 | >50 | 每月 |
| **性能** | P99延迟 | <100ms | 实时 |
| **稳定性** | 可用性 | >99.9% | 实时 |

### 5.2 业务价值指标

| 价值维度 | 衡量指标 | 预期提升 | 价值说明 |
|---------|---------|---------|---------|
| **效率提升** | 问题定位时间 | -70% | 从小时级到分钟级 |
| **质量改善** | 线上问题数 | -50% | 预防性监控 |
| **成本节省** | 运维人力 | -30% | 自动化分析 |
| **业务增长** | 系统吞吐量 | +40% | 性能优化 |

### 5.3 用户行为指标

**功能使用分布**：
- 流程追踪：40%
- 性能分析：25%
- 变更监控：20%
- 报告生成：15%

**用户路径分析**：
- 平均会话深度：5个页面
- 跳出率：<20%
- 功能转化率：>60%

---

## 6. 技术约束与非功能需求

### 6.1 性能要求

| 场景 | 指标要求 | 优先级 |
|------|---------|--------|
| 数据采集 | 性能损耗<5% | P0 |
| 实时查询 | 响应时间<1s | P0 |
| 报告生成 | 生成时间<5s | P1 |
| 批量分析 | 1万节点<10s | P1 |

### 6.2 扩展性要求

- **水平扩展**：支持集群部署
- **数据规模**：单日10亿调用
- **并发用户**：1000+同时在线
- **存储容量**：PB级数据存储

### 6.3 兼容性要求

- **JDK版本**：8, 11, 17, 21
- **Spring版本**：Boot 2.4+, 3.0+
- **数据库**：MySQL, PostgreSQL, Oracle
- **浏览器**：Chrome, Firefox, Safari, Edge

### 6.4 安全要求

- **数据安全**：敏感数据脱敏
- **访问控制**：RBAC权限模型
- **审计日志**：全量操作记录
- **传输加密**：HTTPS/TLS

---

## 7. 实施路线图

### 7.1 版本规划

#### M2.1 版本（基础增强，2周）
**目标**：完善核心功能，提升易用性

**关键交付**：
- ✅ 注解支持与AOP集成
- ✅ 基础变更追踪
- ✅ Spring Boot Starter
- ✅ 简单HTML报告

**成功标准**：
- 集成时间 < 10分钟
- 零配置可运行

#### M2.2 版本（智能分析，3周）
**目标**：智能化升级，自动化分析

**关键交付**：
- ✅ 智能瓶颈分析
- ✅ 监控规则引擎
- ✅ 交互式HTML报告
- ✅ MDC日志集成

**成功标准**：
- 自动识别80%性能问题
- 报告可读性评分 > 8/10

#### M2.3 版本（生产就绪，2周）
**目标**：生产级品质，企业级特性

**关键交付**：
- ✅ 持久化存储
- ✅ 集群支持
- ✅ 性能优化
- ✅ 安全加固

**成功标准**：
- 支持10000 TPS
- 99.9%可用性

### 7.2 推广策略

**技术社区推广**：
- 开源发布到GitHub
- 技术博客系列文章
- 技术大会演讲
- 视频教程制作

**企业客户拓展**：
- POC试点项目
- 标杆客户案例
- 行业解决方案
- 渠道合作伙伴

### 7.3 风险管理

| 风险类型 | 风险描述 | 影响 | 缓解措施 |
|---------|---------|------|---------|
| 技术风险 | 性能开销过大 | 高 | 采样机制、异步处理 |
| 市场风险 | 竞品功能追赶 | 中 | 快速迭代、差异化 |
| 运营风险 | 用户采用缓慢 | 中 | 降低门槛、培训支持 |
| 资源风险 | 开发资源不足 | 低 | 优先级管理、外包 |

---

## 8. 成功标准与验收

### 8.1 产品成功标准

**量化指标**：
- 活跃企业用户：100+
- 月度活跃开发者：1000+
- GitHub Stars：1000+
- 用户满意度：>85%

**质化指标**：
- 成为Java流程监控首选方案
- 建立技术社区影响力
- 形成行业最佳实践

### 8.2 验收标准

**功能验收**：
- [ ] 所有P0功能100%完成
- [ ] P1功能完成度>80%
- [ ] 通过用户验收测试

**性能验收**：
- [ ] 性能指标达标
- [ ] 压力测试通过
- [ ] 无内存泄漏

**文档验收**：
- [ ] 用户手册完整
- [ ] API文档完善
- [ ] 示例代码充分

---

## 9. 附录

### 9.1 术语表

| 术语 | 定义 | 说明 |
|------|------|------|
| Session | 会话 | 一次完整的业务流程执行 |
| Task | 任务 | 流程中的一个执行节点 |
| Change | 变更 | 数据状态的改变 |
| Bottleneck | 瓶颈 | 性能问题的关键节点 |

### 9.2 参考资料

- Gartner APM魔力象限报告
- ThoughtWorks技术雷达
- Stack Overflow开发者调查
- InfoQ架构趋势报告

### 9.3 相关文档

- [TaskFlow-Insight-M1-Design.md](../../../TaskFlow-Insight-M1-Design.md)
- [TaskFlow-Insight-M2-Design.md](TaskFlow-Insight-M2-Design.md)
- [TaskFlow-Insight-HLD.md](../../../TaskFlow-Insight-HLD.md)

---

**文档版本历史**

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|---------|
| 2.0.0 | 2025-01-09 | 产品团队 | M2正式版发布 |
| 1.0.0 | 2024-12-01 | 产品团队 | M1版本 |
