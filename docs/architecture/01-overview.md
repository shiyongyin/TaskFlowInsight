# 整体架构

## 系统概述

TaskFlow Insight 采用分层架构设计，从上到下分为：集成层、API 层、核心引擎、数据处理层、存储层。

## 架构图

```
┌─────────────────────────────────────────────────────┐
│                 业务应用层                            │
│              Application Code                        │
├─────────────────────────────────────────────────────┤
│                  集成层                              │
│              Integration Layer                       │
│  ┌──────────┬──────────┬──────────┬─────────────┐  │
│  │ Spring   │ 注解支持  │   AOP    │ Manual API  │  │
│  │ Boot     │@TFITask  │ Aspect   │   TFI.*     │  │
│  └──────────┴──────────┴──────────┴─────────────┘  │
├─────────────────────────────────────────────────────┤
│                  API 门面                            │
│               API Facade                             │
│        统一的作用域式和手动式 API 接口                │
├─────────────────────────────────────────────────────┤
│                 核心引擎                             │
│               Core Engine                            │
│  ┌──────────┬──────────┬──────────┬─────────────┐  │
│  │  上下文   │  会话    │  计时器   │   清理器    │  │
│  │ Context  │ Session  │  Timer   │  Cleaner    │  │
│  │ Manager  │ Manager  │ Engine   │  Service    │  │
│  └──────────┴──────────┴──────────┴─────────────┘  │
├─────────────────────────────────────────────────────┤
│               数据处理层                             │
│            Data Processing Layer                     │
│  ┌──────────┬──────────┬──────────┬─────────────┐  │
│  │  性能    │  变更    │  消息    │   分析器    │  │
│  │Collector │ Tracker  │Collector │  Analyzers  │  │
│  └──────────┴──────────┴──────────┴─────────────┘  │
├─────────────────────────────────────────────────────┤
│                导出层                               │
│              Export Layer                           │
│  ┌──────────┬──────────┬──────────┬─────────────┐  │
│  │  文本    │   JSON   │  指标    │   HTML      │  │
│  │  Tree    │ Export   │ Export   │  Report     │  │
│  └──────────┴──────────┴──────────┴─────────────┘  │
├─────────────────────────────────────────────────────┤
│                存储层                               │
│              Storage Layer                          │
│        ThreadLocal + 全局索引 + 配置管理             │
└─────────────────────────────────────────────────────┘
```

## 分层设计

### 1. 集成层 (Integration Layer)

负责与外部框架和应用代码的集成：

- **Spring Boot Starter**: 自动配置和依赖注入
- **注解支持**: `@TFITask` 等注解驱动的任务追踪
- **AOP 切面**: 自动拦截方法调用
- **Manual API**: 手动编程接口

### 2. API 门面 (API Facade)

提供统一的编程接口：

- **作用域式 API**: `TFI.task("name").execute(() -> {...})`
- **手动式 API**: `TFI.start("name")` / `TFI.stop()`
- **上下文管理**: 任务上下文的创建、获取、销毁

### 3. 核心引擎 (Core Engine)

系统的核心处理逻辑：

- **上下文管理器**: ThreadLocal 上下文管理
- **会话管理器**: 多会话隔离和生命周期管理  
- **计时引擎**: 高精度时间测量和统计
- **清理服务**: 自动清理过期数据

### 4. 数据处理层 (Data Processing Layer)

数据收集、分析和处理：

- **性能收集器**: CPU、内存、时间等指标收集
- **变更追踪器**: 对象状态变更监控
- **消息收集器**: 业务消息和日志收集
- **分析器**: 瓶颈分析、模式识别等

### 5. 导出层 (Export Layer)

数据输出和可视化：

- **文本导出**: 控制台树形输出
- **JSON 导出**: 结构化数据输出  
- **指标导出**: Micrometer/Prometheus 集成
- **HTML 报告**: 可视化报告生成

### 6. 存储层 (Storage Layer)

数据存储和管理：

- **ThreadLocal 存储**: 线程级任务栈和会话
- **全局索引**: 跨线程访问的会话索引
- **配置管理**: 运行时配置和热更新

## 关键设计决策

### 1. 多线程隔离

- 使用 ThreadLocal 确保线程间数据隔离
- 全局索引支持跨线程读取
- COW (Copy-On-Write) 策略确保并发读取一致性

### 2. 内存管理

- 会话级别的生命周期管理
- 自动清理机制防止内存泄漏
- 可配置的上限和采样策略

### 3. 性能优化

- 异步导出避免阻塞主流程
- 采样机制降低开销
- 轻量级数据结构减少内存占用

### 4. 可扩展性

- SPI 机制支持插件化扩展
- 分层解耦便于组件替换
- 配置外部化支持定制化部署

## 数据流

### 任务执行流程

```
1. start(name) -> 创建 Node，压入栈
2. 业务执行 -> 收集性能数据、变更信息
3. stop() -> 出栈，计算时长，回溯累计
4. 根任务完成 -> 封装 Session，加入索引
5. 导出/清理 -> 异步处理，释放资源
```

### 跨线程访问流程

```
1. 会话结束 -> 冻结为不可变树
2. 加入全局索引 -> 支持跨线程访问
3. 读取请求 -> 零锁访问不可变快照
4. 清理触发 -> 从索引中移除过期会话
```

## 关键指标

- **启动开销**: < 100ms
- **运行开销**: < 5% CPU
- **内存占用**: < 50MB 基础占用
- **并发能力**: 支持 1000+ 并发线程
- **数据容量**: 10000+ 任务节点/线程