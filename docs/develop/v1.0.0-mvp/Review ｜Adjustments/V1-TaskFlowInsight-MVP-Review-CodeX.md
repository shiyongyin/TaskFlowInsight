 TaskFlowInsight v1.0.0‑MVP 开发任务评审与调整建议

## 评审范围
- 路径: `docs/develop/v1.0.0-mvp/`（MASTER_TASK_LIST 与各模块 DEV-* 实现任务卡）
- 对照: `docs/version/v1.0.0-mvp/`（基线规格/开发规范）与 `docs/task/v1.0.0-mvp/`（任务规格）

## 总体结论
- 结构清晰、格式统一：每张任务卡均包含目标/设计/测试/验收/计划，便于执行与审查。
- 小范围不一致与口径偏差需修正：个别接口与指标表述、统计信息与现实达成度。
- 少量“过度设计”点建议降级为可选/开关化，以保障 MVP 可交付性与可验证性。

## 关键发现（按模块）
- 核心数据模型（DEV‑001…005）
  - 状态：基本对齐，测试覆盖全面。
  - 问题：DEV‑002（TaskNode）存在 final 字段（`sequence`/`taskPath`）与后续更新逻辑冲突；时长 API 命名不统一。
  - 建议：去掉 final 或在构造期确定；统一命名为 `getDurationNanos/getDurationMillis`，累计为 `getAccumulatedDurationMillis`。

- 上下文管理（DEV‑006…009）
  - 改进亮点：
    - DEV‑006 引入 `ManagedThreadContext`（AutoCloseable），强制 try‑with‑resources 清理；提供 `ContextSnapshot`；嵌套检测与父子恢复；线程池安全包装示例。
    - DEV‑007 `SafeContextManager` 防御性创建/清理；InheritableThreadLocal + 快照恢复；`executeAsync` 与 `TFIAwareThreadPool` 支持上下文传播；定期漏检/修复。
  - 待完善：
    - DEV‑006：补齐 `ContextSnapshot.restore()` 的签名/语义与示例；修正 `isTaskBelongsToSession(...)` 临时实现；将“编译器警告”表述为“建议配合 IDE/静态分析”。
    - DEV‑007：文中引用 `ManagedThreadContext.NOOP_CONTEXT` 未定义（需在 DEV‑006 定义或改用判空流程）；明确 InheritableThreadLocal 的边界，建议“包装/快照优先”；补充虚拟线程（Thread.ofVirtual/StructuredTaskScope）示例与测试。
    - DEV‑009：增补异步链路、线程池、虚拟线程、嵌套/异常/清理断言的测试用例。

- API 实现（DEV‑010…013）
  - 状态：目标明确、验收可测；异常安全设计合理。
  - 建议：DEV‑010 明确“最小 API（start/stop/message/recordException）”与“增强 API（debug/warn/exception）”的兼容层关系。

- 输出与导出（DEV‑014…015）
  - 状态：控制台输出清晰、覆盖简洁与增强两种风格；JSON 导出功能完备。
  - 建议：为 DEV‑015 引入导出模式 `compat/enhanced`（compat 默认与基线示例一致，enhanced 输出 `$schema`/统计/纳秒等扩展），并提供对照示例与测试开关。

- 性能与稳定性（DEV‑016…019）
  - 状态：基准/并发/长期稳定性任务齐全。
  - 问题：DEV‑016 延迟指标过于理想（如 P50<1μs），建议以“CPU 开销 < 5%”为核心验收，延迟指标按 P50/P95/P99 分层给出现实区间。

- 性能优化（DEV‑020…023）
  - 状态：作为后续优化项合理；避免影响 MVP 主路径。
  - 建议：全部以开关/可选模块实现，附基准对比与“收益门槛”（何时开启）。

## 过度设计风险与处理
- 反射清理 ThreadLocalMap（DEV‑008）
  - 风险：与 JDK 内部实现耦合、权限/可移植性/性能风险高。
  - 处理：置于“诊断模式”开关（默认关闭），明确风险与替代路径；常规采用托管上下文 + 传播包装方案。
- 绝对化指标表述
  - “100%资源清理/零泄漏保证”“任务操作 <100ns/API <1μs”：改为“设计目标 + 观测验证 + 分层指标”，同时以“CPU 开销 < 5%”为主验收。
- 扩展枚举/导出格式
  - 保留为增强/可选，默认走 compat 模式，减少对 MVP 范围的影响。

## 验收标准清晰度评估
- 多数任务卡具备可测验收（功能、性能、边界、异常、并发）。
- 需增强可测性项：
  - 上下文传播/虚拟线程（DEV‑006/007/009）：补充虚拟线程与 CompletableFuture/ForkJoinPool 场景用例；定义 `restore()` 语义与清理约束。
  - JSON 兼容模式（DEV‑015）：提供两个模式的对照测试与默认行为说明。
  - 性能指标（DEV‑016）：以 CPU 开销为主验收，延迟指标分档并绑定硬件/JVM 说明。

## 文档一致性与版本口径
- MASTER_TASK_LIST.md 顶部统计“已生成20/待补充3”与文末“23/23已生成”矛盾，建议统一为“23/23 已生成”。
- JDK 口径：工程使用 Java 21；基线仍提“最低 8/推荐 11+”。建议统一为“Java 21”为实施版本，并在基线补充向下兼容/运行时注意事项说明。

## 高优先调整建议（行动单）
1) DEV‑006：补齐 `ContextSnapshot.restore()` 定义/示例；修正任务归属判断；表述改为“建议配合 IDE/静态分析”。
2) DEV‑007：定义 `NOOP_CONTEXT` 或移除依赖；明确 InheritableThreadLocal 边界，推荐“包装/快照优先”；补充虚拟线程示例与测试。
3) DEV‑009：增加异步链路/虚拟线程/线程池/嵌套/异常/强制清理的综合测试用例。
4) DEV‑015：加入 `compat/enhanced` 导出模式、默认 compat、提供对照示例与测试开关。
5) DEV‑016：指标校准为“CPU 开销 < 5%”为主，延迟指标按 P50/P95/P99 设现实区间。
6) DEV‑002：去除 final 与更新冲突、统一时长 API 命名，补全序号与路径逻辑。
7) MASTER_TASK_LIST：修正文案统计；JDK 版本统一为 21 并在基线说明兼容口径。
8) DEV‑008：将反射清理置为诊断开关（默认关闭），补充风险说明与观测指标（泄漏检测计数/紧急清理次数/上下文年龄分布）。

## 是否遵循“避免过度设计前提下的最佳实现”
- 是，整体方案在托管上下文（强制清理）、传播包装（可观测）、分层可选能力（增强关闭）等方面，兼顾了工程可交付性与可演进性。
- 建议将“增强/诊断/优化”能力全部开关化并默认关闭；以兼容/最小模式作为默认实现路径，配合完善的基准与验证脚本，避免偏离 MVP 目标。

## 附：可执行检查清单（交付前）
- [ ] 006/007/009 已补齐 `restore()`/NOOP/虚拟线程与异步链路用例。
- [ ] 015 已支持 compat/enhanced 模式与默认 compat 行为，测试通过。
- [ ] 016 指标以 CPU 开销为主，延迟指标分档并有硬件/JVM 说明。
- [ ] 002 已修正 final/更新冲突，时长 API 命名统一。
- [ ] MASTER_TASK_LIST 任务统计一致，JDK 版本一致对外口径为 21。
- [ ] 008 反射清理置于诊断开关（默认关闭），风险/观测指标到位。

— 评审日期：2025‑09‑05
