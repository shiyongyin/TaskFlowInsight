# DEV-014: 控制台输出实现

## 任务卡信息

- **任务ID**: DEV-014
- **任务名称**: 控制台树形输出实现 
- **类别**: 输出实现
- **优先级**: P1 (高)
- **预估工期**: 2天
- **状态**: 待分配
- **进度**: 0%
- **负责人**: 待分配
- **创建日期**: 2025-09-05

## 目标

### 核心目标
实现简洁、清晰的控制台输出器，将TaskFlow Insight的任务树结构以ASCII树形格式展示给用户，提供基本的视觉化任务执行报告。

### 关键结果指标
1. 支持完整的任务树层次结构显示
2. 输出生成时间 < 10ms (1000个节点)
3. 内存使用 < 1MB 临时缓存
4. ASCII字符正确对齐，视觉效果清晰
5. 单元测试覆盖率 ≥ 95%

## 关键实现方式

### 主要技术方案
1. **ConsoleExporter核心实现**
   - 使用StringBuilder进行高效字符串构建
   - 递归遍历TaskNode树结构
   - ASCII字符绘制树形结构 (├──, └──, │, 空格)
   - 支持会话信息和任务执行统计展示

2. **输出格式设计**
   - 标准化报告头部 (会话ID、线程ID、状态、耗时)
   - 树形结构可视化 (层次缩进、连接线、节点信息)
   - 节点行格式：名称（累计时长, self 自身时长, 状态）
   - 任务状态标识 (COMPLETED、FAILED、RUNNING等)
   - 内嵌消息显示 ([INFO]、[ERROR]、[WARN]等)

3. **多输出流支持**
   - 默认System.out控制台输出
   - 支持自定义PrintStream输出
   - 支持导出为字符串用于集成

### 核心实现步骤
1. **第1天**: ConsoleExporter核心类实现
   - 实现基本的export()方法
   - 完成递归树遍历算法
   - 实现ASCII字符树形绘制
   - 添加会话信息头部格式化

2. **第2天**: 优化和测试
   - 性能优化 (StringBuilder预分配、字符重用)
   - 边界条件处理 (null处理、空树处理)  
   - 完整单元测试套件
   - 输出格式美化和对齐

### 关键技术点
1. **高效字符串构建**: 使用StringBuilder避免字符串拼接开销
2. **递归算法设计**: 正确处理树形结构的前缀传递
3. **ASCII字符对齐**: 确保不同深度节点的视觉对齐效果
4. **内存管理**: 避免大对象创建，控制临时内存使用

## 依赖关系

### 前置依赖任务
- DEV-001: Session会话模型实现 ✅ 
- DEV-002: TaskNode任务节点实现 ✅
- DEV-003: Message消息模型实现 ✅
- DEV-004: Enums枚举定义实现 ✅

### 阻塞任务列表
- 当前无阻塞任务

### 依赖的外部组件
- Java标准库 (StringBuilder, PrintStream, Writer)
- TaskFlow Insight核心数据模型

## 单元测试标准

### 测试覆盖要求
- **代码覆盖率**: ≥ 95%
- **分支覆盖率**: ≥ 90%  
- **方法覆盖率**: 100%

### 关键测试用例
1. **基本功能测试**
   ```java
   @Test void testBasicSessionExport()
   @Test void testEmptySessionExport() 
   @Test void testNullSessionExport()
   @Test void testSingleTaskExport()
   ```

2. **树结构测试**
   ```java
   @Test void testNestedTaskTree()
   @Test void testMultipleChildrenTasks()
   @Test void testDeepNestingLevel()
   @Test void testComplexTaskHierarchy()
   ```

3. **格式化测试**
   ```java
   @Test void testAsciiTreeAlignment()
   @Test void testTaskStatusDisplay()
   @Test void testMessageDisplay()
   @Test void testTimeFormatting()
   ```

4. **边界条件测试**
   ```java
   @Test void testMaxDepthHandling()
   @Test void testLargeTaskCount()
   @Test void testSpecialCharacters()
   @Test void testLongTaskNames()
   ```

### 性能测试要求
1. **输出生成性能**: 1000个节点 < 10ms
2. **内存使用测试**: 临时内存 < 1MB
3. **大数据量测试**: 10000个节点能正常处理
4. **并发安全测试**: 多线程调用的安全性

## 验收标准

### 功能验收标准
- [x] **会话信息完整**: 正确显示sessionId、threadId、status、duration
- [x] **树形结构正确**: ASCII字符准确表示层次关系
- [x] **任务信息完整**: 显示任务名称、耗时、状态、错误信息
- [x] **消息显示正确**: 按类型和时间正确显示任务消息
- [x] **多输出流支持**: 支持System.out和自定义PrintStream
- [x] **错误处理完善**: null输入、空数据等异常情况正确处理

### 代码质量要求
- [x] **代码结构清晰**: 方法职责单一，逻辑清晰易读
- [x] **注释完整**: 关键算法和业务逻辑有详细注释
- [x] **命名规范**: 变量和方法命名清晰，符合Java命名约定
- [x] **异常处理**: 完善的异常捕获和处理机制
- [x] **线程安全**: 无共享状态，支持并发调用
- [x] **内存效率**: 无内存泄漏，合理控制内存使用

### 性能指标要求
- [ ] **生成性能**: 1000节点输出生成 < 10ms
- [ ] **内存使用**: 临时内存占用 < 1MB  
- [ ] **字符串构建效率**: 合理使用StringBuilder
- [x] **算法时间复杂度**: O(n) 时间复杂度，n为节点数量

审核不通过原因：
- 生成性能/内存使用/字符串构建效率：当前仓库无针对 `ConsoleExporter` 的性能与内存基准测试数据，无法据此验证阈值是否满足；建议补充基准测试后再勾选。

## 风险识别

### 技术风险点
1. **大数据量性能问题**
   - **风险描述**: 节点数量过大时输出生成缓慢
   - **影响程度**: 中等
   - **缓解措施**: 使用StringBuilder预分配、字符串缓存、分页输出

2. **ASCII字符对齐问题**  
   - **风险描述**: 不同字符宽度导致显示错位
   - **影响程度**: 低
   - **缓解措施**: 固定宽度字符集、详细测试验证

3. **内存使用过高**
   - **风险描述**: 大量字符串拼接导致内存消耗
   - **影响程度**: 中等  
   - **缓解措施**: 流式输出、StringBuilder预分配、及时清理

### 进度风险
1. **递归算法复杂性**
   - **风险描述**: 树遍历逻辑复杂导致开发延期
   - **影响程度**: 低
   - **缓解措施**: 参考现有实现、先实现简化版本

2. **测试用例复杂性**
   - **风险描述**: 输出格式验证测试编写困难
   - **影响程度**: 低
   - **缓解措施**: 使用字符串比较、正则表达式验证

## 实施计划

### Day 1: 核心实现
- **09:00-12:00**: ConsoleExporter类框架搭建
- **13:00-15:00**: 基本export()方法实现
- **15:00-17:00**: 树遍历递归算法实现
- **17:00-18:00**: 基本功能测试和调试

### Day 2: 优化和测试  
- **09:00-10:00**: ASCII字符对齐优化
- **10:00-12:00**: 性能优化 (StringBuilder预分配等)
- **13:00-15:00**: 完整单元测试套件编写
- **15:00-16:30**: 边界条件测试和修复
- **16:30-18:00**: 文档编写和代码审查准备

## 交付物

1. **源代码文件**
   - `ConsoleExporter.java` - 核心导出器实现
   - `ConsoleExporterTest.java` - 完整测试套件

2. **测试结果**
   - 单元测试报告 (覆盖率 ≥ 95%)
   - 性能测试报告 (输出生成性能验证)
   - 功能验收测试结果

3. **技术文档**
   - API使用文档和示例
   - 输出格式规范说明
   - 性能特性和限制说明

## 使用示例

### 基本使用
```java
// 基本导出
Session session = getCurrentSession();
ConsoleExporter exporter = new ConsoleExporter();
exporter.print(session);

// 导出到字符串
String output = exporter.export(session);

// 导出到文件
try (PrintStream fileOut = new PrintStream("task-report.txt")) {
    exporter.print(session, fileOut);
}
```

### 输出示例
```
==================================================
TaskFlow Insight Report
==================================================
Session: 550e8400-e29b-41d4-a716-446655440000
Thread:  1
Status:  COMPLETED
Duration: 1250ms

└── Main Task (1250ms, COMPLETED)
    ├── Database Query (300ms, COMPLETED)
    │     [INFO] Connecting to database
    │     [INFO] Query executed successfully
    ├── Data Processing (800ms, COMPLETED)
    │   ├── Validation (100ms, COMPLETED)
    │   └── Transformation (700ms, COMPLETED)
    └── Response Generation (150ms, COMPLETED)
          [INFO] Response formatted as JSON
==================================================
```

---

**备注**: 此任务专注于MVP核心功能，后续版本可考虑添加颜色支持、多种输出格式、配置选项等高级特性。
