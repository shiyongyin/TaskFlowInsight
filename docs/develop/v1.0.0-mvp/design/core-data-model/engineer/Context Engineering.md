# Context Engineering for TaskFlowInsight v1.0.0 MVP

## 项目背景上下文

### 核心定位
TaskFlowInsight是一个**轻量级、高性能的任务执行追踪框架**，专注于提供零侵入、低开销的任务追踪能力。

### 技术决策上下文
- **语言环境**: Java 21 + Spring Boot 3.5.5
- **构建工具**: Maven with wrapper
- **包结构**: com.syy.taskflowinsight
- **端口配置**: 19090

### 设计哲学上下文
1. **KISS原则**: 保持简单直接，拒绝过度设计
2. **可读性优先**: 代码清晰度高于巧妙实现
3. **性能第二**: 在保证可读性前提下优化性能
4. **真实流程**: 测试不使用mock，验证真实执行路径

## 开发上下文层次结构

### Level 1: 项目级上下文
```
TaskFlowInsight/
├── 业务目标: 任务执行追踪与可视化
├── 技术约束: 无外部依赖、CPU开销<5%
├── 质量标准: 测试覆盖率≥95%
└── 交付范围: MVP版本23个任务
```

### Level 2: 模块级上下文
```
核心数据模型 (Phase 1)
├── Session: 会话管理与生命周期
├── TaskNode: 任务节点与树形结构
├── Message: 消息记录与不可变性
└── Enums: 状态与类型定义

上下文管理 (Phase 2)
├── ThreadContext: 线程级上下文
├── ContextManager: 上下文生命周期
└── Memory Management: 内存安全保证

API接口 (Phase 3)
├── TFI: 主入口API
├── TaskContext: 任务上下文API
└── Exception Safety: 异常安全机制
```

### Level 3: 实现级上下文
```
每个类的上下文要素:
├── 线程安全策略
│   ├── 读写分离模式
│   ├── volatile字段标记
│   └── 同步边界定义
├── 时间粒度管理
│   ├── 毫秒级(Session)
│   └── 纳秒级(TaskNode)
├── 状态转换规则
│   ├── 幂等性保证
│   └── 并发安全保证
└── 内存管理策略
    ├── 对象生命周期
    └── 集合并发策略
```

## 关键上下文约束

### 性能约束上下文
```yaml
CPU开销:
  总体: < 5% 业务逻辑执行时间
  API延迟:
    P50: < 2μs
    P95: < 10μs
    P99: < 50μs

内存约束:
  总体占用: < 5MB
  单任务占用: < 1KB
  TaskNode创建: < 5μs (10000次平均)
  
并发约束:
  支持线程数: 1000+
  无锁化设计: 优先使用CAS
```

### 代码规范上下文
```java
// 格式规范
缩进: 4空格
行宽: 最大120字符
注释: 中文简洁说明因果/边界/约束

// 命名规范
类名: PascalCase
方法: camelCase
常量: UPPER_SNAKE_CASE
包名: 全小写

// 设计规范
可见性: 最小化原则
不可变: 优先使用final
线程安全: volatile/synchronized明确标注
```

### 测试上下文
```yaml
单元测试:
  覆盖率要求:
    行覆盖: ≥ 95%
    方法覆盖: ≥ 95%
    分支覆盖: ≥ 90% (期望)
  
  测试原则:
    - 不使用mock框架
    - 真实对象交互
    - 业务场景优先
    - 边界条件必须覆盖

性能测试:
  基准测试: JMH或简单计时
  并发测试: 多线程场景验证
  长稳测试: 内存泄漏检测
```

## 工作流上下文

### 四阶段工作流
```mermaid
graph LR
    A[方案评估] --> B[高质量编码]
    B --> C[测试与审核]
    C --> D[文档回填]
    
    A --> |100%明确| B
    B --> |自检通过| C
    C --> |覆盖率达标| D
```

### 决策上下文优先级
1. **开发卡优先**: 设计文档与开发卡冲突时，以开发卡为准
2. **问题先行**: 不明确的问题必须先记录到ISSUES文档
3. **假设记录**: 允许的假设必须记录并计划回填
4. **偏差标注**: 实现偏差必须在DEV文档中说明

## 协作上下文

### 文档体系
```
docs/
├── task/          # 原始需求与设计
├── develop/       # 开发任务卡
│   ├── ISSUES-*.md     # 问题清单
│   ├── DEV-*.md        # 开发卡
│   └── TEST-REPORT.md  # 测试报告
└── Context Engineering.md  # 本文档
```

### 沟通上下文
- **问题升级路径**: 开发疑问 → ISSUES文档 → 等待确认 → 实施
- **变更管理**: 所有变更必须记录原因和影响
- **验收标准**: 明确的量化指标，可测量可验证

## 上下文检查清单

### 开始编码前确认
- [ ] 设计方案和开发卡已仔细阅读
- [ ] 冲突和疑问已记录到ISSUES
- [ ] 性能预算和测试要求明确
- [ ] 线程安全策略已确定
- [ ] 时间粒度要求已理解

### 编码过程中维护
- [ ] 每个public API都有明确注释
- [ ] 线程安全考虑已实施
- [ ] 异常处理完整且信息充分
- [ ] 性能关键路径已识别
- [ ] 测试用例同步编写

### 交付前验证
- [ ] 测试覆盖率达到要求
- [ ] 性能指标满足预算
- [ ] 文档已更新完整
- [ ] 代码审查通过
- [ ] 集成测试通过

## 上下文使用指南

1. **理解优先级**: 先理解项目级上下文，再深入模块级，最后关注实现细节
2. **保持一致性**: 所有决策都应与已建立的上下文保持一致
3. **及时更新**: 上下文变化时及时更新文档，保持同步
4. **团队共识**: 重要的上下文变更需要团队评审和共识

---

*本文档作为TaskFlowInsight项目的核心上下文参考，应随项目演进持续更新。*

**创建日期**: 2025-01-06  
**版本**: v1.0.0  
**维护者**: TaskFlowInsight开发团队