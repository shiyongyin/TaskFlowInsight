# CONTEXT-CORE-DATAMODEL.md - æ ¸å¿ƒæ•°æ®æ¨¡å‹ä¸“ç”¨ä¸Šä¸‹æ–‡

## ğŸ“š æ¨¡å—ä¸Šä¸‹æ–‡å®šä½

### æ¨¡å—è§’è‰²
æ ¸å¿ƒæ•°æ®æ¨¡å‹æ˜¯TaskFlowInsightçš„**åŸºç¡€è®¾æ–½å±‚**ï¼Œæä¾›ä»»åŠ¡è¿½è¸ªçš„åŸºæœ¬æ•°æ®ç»“æ„å’Œæ“ä½œåŸè¯­ã€‚æ‰€æœ‰ä¸Šå±‚åŠŸèƒ½éƒ½ä¾èµ–äºè¿™äº›æ ¸å¿ƒæ¨¡å‹ã€‚

### æ¨¡å—è¾¹ç•Œ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸Šå±‚ä¸šåŠ¡åŠŸèƒ½                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      APIå±‚ (TFI/TaskContext)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ä¸Šä¸‹æ–‡ç®¡ç† (ThreadContext)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¶ æ ¸å¿ƒæ•°æ®æ¨¡å‹ (å½“å‰æ¨¡å—) â—€       â”‚
â”‚    - Session: ä¼šè¯å®¹å™¨             â”‚
â”‚    - TaskNode: ä»»åŠ¡èŠ‚ç‚¹            â”‚
â”‚    - Message: æ¶ˆæ¯è®°å½•             â”‚
â”‚    - Enums: çŠ¶æ€æšä¸¾               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¾èµ–å…³ç³»ä¸Šä¸‹æ–‡
```mermaid
graph TD
    Session --> TaskNode[ä½¿ç”¨TaskNodeä½œä¸ºroot]
    TaskNode --> Message[å­˜å‚¨Messageåˆ—è¡¨]
    TaskNode --> TaskStatus[ä½¿ç”¨TaskStatusæšä¸¾]
    Session --> SessionStatus[ä½¿ç”¨SessionStatusæšä¸¾]
    Message --> MessageType[ä½¿ç”¨MessageTypeæšä¸¾]
```

## ğŸ¯ æ ¸å¿ƒè®¾è®¡å†³ç­–ä¸Šä¸‹æ–‡

### æ—¶é—´ç²¾åº¦å†³ç­–
| ç»„ä»¶ | ç²¾åº¦ | åŸå›  | ä½¿ç”¨åœºæ™¯ |
|------|------|------|----------|
| Session | æ¯«ç§’ | ä¼šè¯çº§åˆ«ä¸éœ€è¦é«˜ç²¾åº¦ | createdAt, endedAt, getDurationMs() |
| TaskNode | çº³ç§’ | ä»»åŠ¡å¯èƒ½å¾ˆçŸ­ï¼Œéœ€è¦é«˜ç²¾åº¦ | startNano, endNano, getDurationNanos() |
| Message | åŒç²¾åº¦ | æ’åºéœ€è¦çº³ç§’ï¼Œæ˜¾ç¤ºç”¨æ¯«ç§’ | timestampNanos(æ’åº), timestampMillis(æ˜¾ç¤º) |

### çº¿ç¨‹å®‰å…¨ç­–ç•¥
```java
// Sessionçº¿ç¨‹å®‰å…¨æ¨¡å¼
public class Session {
    private final long createdAt;        // final: ä¸å˜å­—æ®µ
    private volatile long endedAt;       // volatile: è·¨çº¿ç¨‹å¯è§
    private volatile SessionStatus status; // volatile: çŠ¶æ€åŒæ­¥
    
    public synchronized void end() {     // synchronized: å†™æ“ä½œåŒæ­¥
        // å¹‚ç­‰æ€§å®ç°
    }
}

// TaskNodeçº¿ç¨‹å®‰å…¨æ¨¡å¼
public class TaskNode {
    private final String nodeId;         // final: ä¸å˜å­—æ®µ
    private volatile TaskStatus status;  // volatile: çŠ¶æ€å¯è§æ€§
    private final CopyOnWriteArrayList<Message> messages; // æ— é”è¯»
    
    public synchronized void stop() {    // synchronized: çŠ¶æ€è½¬æ¢åŒæ­¥
        // çŠ¶æ€è½¬æ¢é€»è¾‘
    }
}
```

### å†…å­˜ç®¡ç†å†³ç­–
| ç­–ç•¥ | å®ç°æ–¹å¼ | æ”¶ç›Š |
|------|---------|------|
| é¢„åˆ†é… | ArrayListåˆå§‹å®¹é‡8 | å‡å°‘æ‰©å®¹å¼€é”€ |
| å¯¹è±¡å¤ç”¨ | é™æ€å·¥å‚æ–¹æ³• | å‡å°‘å¯¹è±¡åˆ›å»º |
| æ‡’åŠ è½½ | æŒ‰éœ€è®¡ç®—ç´¯è®¡æ—¶é•¿ | å‡å°‘æ— ç”¨è®¡ç®— |
| ç´§å‡‘è®¾è®¡ | æœ€å°åŒ–å­—æ®µæ•°é‡ | é™ä½å†…å­˜å ç”¨ |

## ğŸ“Š æ€§èƒ½é¢„ç®—åˆ†é…

### åˆ›å»ºæ€§èƒ½é¢„ç®—
```
æ€»é¢„ç®—: 16å¾®ç§’ï¼ˆåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡è¿½è¸ªï¼‰
â”œâ”€â”€ Sessionåˆ›å»º: 10å¾®ç§’ (62.5%)
â”œâ”€â”€ TaskNodeåˆ›å»º: 5å¾®ç§’ (31.25%)
â””â”€â”€ Messageåˆ›å»º: 1å¾®ç§’ (6.25%)
```

### å†…å­˜é¢„ç®—åˆ†é…
```
å•ä»»åŠ¡è¿½è¸ªæ€»é¢„ç®—: <5KB
â”œâ”€â”€ Sessionå¯¹è±¡: <1KB
â”œâ”€â”€ TaskNodeå¯¹è±¡: <2KB (åŒ…å«å­èŠ‚ç‚¹å¼•ç”¨)
â”œâ”€â”€ Messageå¯¹è±¡: <100å­—èŠ‚/æ¡
â””â”€â”€ é›†åˆå¼€é”€: <1KB
```

### å¹¶å‘æ€§èƒ½é¢„ç®—
```
1000çº¿ç¨‹å¹¶å‘åœºæ™¯:
â”œâ”€â”€ è¯»æ“ä½œ: æ— é”ï¼Œé›¶ç­‰å¾…
â”œâ”€â”€ å†™æ“ä½œ: çŸ­ä¸´ç•ŒåŒºï¼Œ<1å¾®ç§’æŒé”
â”œâ”€â”€ GCå½±å“: <5ms/ç§’
â””â”€â”€ CPUå¼€é”€: <5%æ€»CPUæ—¶é—´
```

## ğŸ”§ å®ç°ç»†èŠ‚ä¸Šä¸‹æ–‡

### Sessionå®ç°è¦ç‚¹
```java
// å…³é”®è®¾è®¡ç‚¹
1. sessionIdä½¿ç”¨UUID.randomUUID()
2. threadId = Thread.currentThread().getId()
3. createdAt = System.currentTimeMillis()
4. end()æ–¹æ³•å¹‚ç­‰æ€§:
   if (status != SessionStatus.RUNNING) return;
   synchronized(this) {
       if (status != SessionStatus.RUNNING) return;
       endedAt = System.currentTimeMillis();
       status = SessionStatus.COMPLETED;
   }
```

### TaskNodeå®ç°è¦ç‚¹
```java
// è·¯å¾„ç”Ÿæˆé€»è¾‘
taskPath = parent == null ? name : parent.taskPath + "/" + name;

// åºå·ç”Ÿæˆé€»è¾‘
sequence = parent == null ? 0 : parent.children.size();

// ç´¯è®¡æ—¶é•¿è®¡ç®—ï¼ˆä¸åšå¹¶è¡Œå»é‡ï¼‰
public long getAccumulatedDurationMillis() {
    long total = getDurationMillis();
    for (TaskNode child : children) {
        total += child.getAccumulatedDurationMillis();
    }
    return total;
}
```

### Messageä¸å¯å˜æ€§ä¿è¯
```java
public final class Message {
    private final String messageId;
    private final String content;
    private final MessageType type;
    private final long timestampMillis;
    private final long timestampNanos;
    
    // ç§æœ‰æ„é€ å™¨ï¼Œåªèƒ½é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»º
    private Message(MessageType type, String content) {
        this.messageId = UUID.randomUUID().toString();
        this.content = Objects.requireNonNull(content);
        this.type = Objects.requireNonNull(type);
        this.timestampNanos = System.nanoTime();
        this.timestampMillis = System.currentTimeMillis();
    }
}
```

## ğŸš« çº¦æŸä¸é™åˆ¶

### ç¡¬æ€§çº¦æŸ
1. **æ— å¤–éƒ¨ä¾èµ–**: ä»…ä½¿ç”¨JDK 21æ ‡å‡†åº“
2. **çº¿ç¨‹å®‰å…¨**: æ‰€æœ‰publicæ–¹æ³•å¿…é¡»çº¿ç¨‹å®‰å…¨
3. **æ€§èƒ½çº¢çº¿**: CPUå¼€é”€ä¸å¾—è¶…è¿‡5%
4. **å†…å­˜ä¸Šé™**: æ€»å ç”¨ä¸å¾—è¶…è¿‡5MB

### è®¾è®¡çº¦æŸ
1. **ä¸ä½¿ç”¨synchronizedå—**: ä»…åœ¨æ–¹æ³•çº§åˆ«åŒæ­¥
2. **ä¸ä½¿ç”¨ReentrantLock**: ä¿æŒç®€å•
3. **ä¸ä½¿ç”¨åå°„**: æ€§èƒ½è€ƒè™‘
4. **ä¸ä½¿ç”¨Stream APIåœ¨çƒ­è·¯å¾„**: é¿å…é¢å¤–å¼€é”€

### æµ‹è¯•çº¦æŸ
1. **ä¸ä½¿ç”¨Mockito**: çœŸå®å¯¹è±¡äº¤äº’
2. **ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡**: çº¯å†…å­˜æµ‹è¯•
3. **ä¸ä½¿ç”¨@SpringBootTest**: è½»é‡çº§å•å…ƒæµ‹è¯•
4. **æµ‹è¯•å¿…é¡»å¯é‡å¤**: æ— éšæœºå¤±è´¥

## ğŸ“ å…³é”®å†³ç­–è®°å½•

### å†³ç­–1: TaskNodeä½¿ç”¨CopyOnWriteArrayListå­˜å‚¨æ¶ˆæ¯
- **åŸå› **: è¯»å¤šå†™å°‘åœºæ™¯ï¼Œæ— é”è¯»å–
- **æƒè¡¡**: å†™å…¥æ—¶å¤åˆ¶å¼€é”€vsè¯»å–æ€§èƒ½
- **ç»“æœ**: æ¥å—å†™å…¥å¼€é”€ï¼Œä¼˜åŒ–è¯»å–è·¯å¾„

### å†³ç­–2: Sessionçš„end()æ–¹æ³•è®¾è®¡ä¸ºå¹‚ç­‰
- **åŸå› **: é˜²æ­¢é‡å¤è°ƒç”¨å¯¼è‡´çŠ¶æ€å¼‚å¸¸
- **å®ç°**: åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼
- **æ”¶ç›Š**: ç®€åŒ–ä¸Šå±‚è°ƒç”¨é€»è¾‘

### å†³ç­–3: ç´¯è®¡æ—¶é•¿ä¸åšå¹¶è¡Œä»»åŠ¡å»é‡
- **åŸå› **: ç®€åŒ–å®ç°ï¼Œé¿å…å¤æ‚çš„æ—¶é—´é‡å è®¡ç®—
- **å½±å“**: å¹¶è¡Œä»»åŠ¡æ—¶é•¿ä¼šé‡å¤è®¡ç®—
- **æ¥å—**: MVPç‰ˆæœ¬å¯æ¥å—æ­¤é™åˆ¶

### å†³ç­–4: Messageè®¾è®¡ä¸ºå®Œå…¨ä¸å¯å˜
- **åŸå› **: çº¿ç¨‹å®‰å…¨ï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹
- **å®ç°**: finalç±»ï¼Œfinalå­—æ®µï¼Œç§æœ‰æ„é€ å™¨
- **æ”¶ç›Š**: æ— éœ€åŒæ­¥ï¼Œå®‰å…¨å…±äº«

## ğŸ” ç–‘éš¾ç‚¹è§£æ

### æ—¶é—´ç²¾åº¦é—®é¢˜
```java
// é—®é¢˜ï¼šSystem.nanoTime()æ˜¯ç›¸å¯¹æ—¶é—´ï¼Œä¸èƒ½è·¨JVMæ¯”è¾ƒ
// è§£å†³ï¼šåŒæ—¶è®°å½•nanoTimeå’ŒcurrentTimeMillis
startNano = System.nanoTime();    // ç”¨äºè®¡ç®—æ—¶é•¿
startMillis = System.currentTimeMillis(); // ç”¨äºç»å¯¹æ—¶é—´

// è®¡ç®—ç›¸å¯¹çº³ç§’
public long getRelativeNanos(long baseNano) {
    return timestampNanos - baseNano;
}
```

### çˆ¶å­å…³ç³»å¾ªç¯å¼•ç”¨
```java
// é—®é¢˜ï¼šparentå’Œchildrenç›¸äº’å¼•ç”¨å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
// è§£å†³ï¼šæ˜ç¡®ç”Ÿå‘½å‘¨æœŸç®¡ç†
1. å­èŠ‚ç‚¹ä¸æŒæœ‰çˆ¶èŠ‚ç‚¹çš„å¼ºå¼•ç”¨ï¼ˆä½¿ç”¨å¼±å¼•ç”¨æˆ–IDï¼‰
2. çˆ¶èŠ‚ç‚¹é”€æ¯æ—¶æ¸…ç†å­èŠ‚ç‚¹åˆ—è¡¨
3. Sessionç»“æŸæ—¶è§¦å‘æ•´ä¸ªæ ‘çš„æ¸…ç†
```

### volatile vs synchronizedé€‰æ‹©
```java
// åŸåˆ™ï¼šè¯»å¤šå†™å°‘ç”¨volatileï¼Œå†™æ“ä½œç”¨synchronized
volatile long endedAt;     // é¢‘ç¹è¯»å–ï¼Œå¶å°”å†™å…¥
synchronized void end() {   // ç¡®ä¿çŠ¶æ€è½¬æ¢åŸå­æ€§
    // ä¸´ç•ŒåŒºå°½é‡å°
}
```

## âœ… å¼€å‘æ£€æŸ¥æ¸…å•

### Sessionå¼€å‘æ£€æŸ¥
- [x] sessionIdæ ¼å¼æ­£ç¡®ï¼ˆUUIDï¼‰âœ…
- [x] çº¿ç¨‹ä¿¡æ¯æ­£ç¡®è·å–ï¼ˆthreadId, threadNameï¼‰âœ…
- [x] æ—¶é—´æˆ³æ¯«ç§’ç²¾åº¦âœ…
- [x] complete()/error()æ–¹æ³•å¹‚ç­‰æ€§âœ…
- [x] volatileå­—æ®µæ­£ç¡®æ ‡è®°âœ…
- [x] activate()æ¿€æ´»ç®¡ç†âœ…
- [x] getDurationMillis()å¤„ç†è¿è¡Œä¸­çŠ¶æ€âœ…

### TaskNodeå¼€å‘æ£€æŸ¥
- [x] çº³ç§’æ—¶é—´ç²¾åº¦å®ç°âœ…
- [x] çˆ¶å­å…³ç³»æ­£ç¡®å»ºç«‹âœ…
- [x] è·¯å¾„ç”Ÿæˆé€»è¾‘æ­£ç¡®âœ…
- [x] æ ‘å½¢ç»“æ„depth/rootè®¡ç®—âœ…
- [x] åŒæ—¶é—´æˆ³(millis+nanos)âœ…
- [x] CopyOnWriteArrayListä½¿ç”¨âœ…
- [x] complete()/fail()åŒæ­¥å®ç°âœ…

### Messageå¼€å‘æ£€æŸ¥
- [x] å®Œå…¨ä¸å¯å˜å®ç°âœ…
- [x] å·¥å‚æ–¹æ³•ï¼ˆinfo/error/error(throwable)ï¼‰âœ…
- [x] åŒæ—¶é—´æˆ³ï¼ˆçº³ç§’+æ¯«ç§’ï¼‰âœ…
- [x] çº¿ç¨‹åç§°è‡ªåŠ¨æ•è·âœ…
- [x] å†…å®¹trimå’ŒéªŒè¯âœ…

### æšä¸¾å¼€å‘æ£€æŸ¥
- [x] æœ€å°åŒ–æšä¸¾å€¼é›†åˆâœ… (SessionStatus:3, TaskStatus:3, MessageType:2)
- [x] ç»ˆæ­¢çŠ¶æ€åˆ¤æ–­æ–¹æ³•âœ… (isActive/isTerminated)
- [x] çº§åˆ«/ä¼˜å…ˆçº§è®¾è®¡âœ… (MessageType level 1,3)
- [x] çŠ¶æ€è½¬æ¢éªŒè¯âœ… (canTransitionTo)

## ğŸ“ æœ€ä½³å®è·µå»ºè®®

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§
1. **ç¼“å­˜è®¡ç®—ç»“æœ**: getDurationMs()å¯ç¼“å­˜å·²ç»“æŸä»»åŠ¡çš„æ—¶é•¿
2. **æ‰¹é‡æ“ä½œ**: æ‰¹é‡æ·»åŠ å­èŠ‚ç‚¹å‡å°‘åŒæ­¥å¼€é”€
3. **é¢„åˆ†é…å®¹é‡**: ArrayList/StringBuilderé¢„è®¾å®¹é‡
4. **å¯¹è±¡æ± åŒ–**: é«˜é¢‘åˆ›å»ºçš„å°å¯¹è±¡è€ƒè™‘æ± åŒ–

### å¹¶å‘ç¼–ç¨‹å®è·µ
1. **æœ€å°åŒ–åŒæ­¥èŒƒå›´**: synchronizedå—å°½é‡å°
2. **ä¼˜å…ˆä½¿ç”¨volatile**: ç®€å•çŠ¶æ€åŒæ­¥ç”¨volatile
3. **è¯»å†™åˆ†ç¦»**: CopyOnWriteArrayListé€‚åˆè¯»å¤šå†™å°‘
4. **é¿å…æ­»é”**: å›ºå®šåŠ é”é¡ºåºï¼Œé¿å…åµŒå¥—é”

### æµ‹è¯•ç­–ç•¥
1. **æ€§èƒ½åŸºå‡†å…ˆè¡Œ**: å…ˆå»ºç«‹æ€§èƒ½baseline
2. **å¹¶å‘æµ‹è¯•å¿…é¡»**: ä½¿ç”¨CountDownLatchåè°ƒ
3. **è¾¹ç•Œæ¡ä»¶è¦†ç›–**: nullã€ç©ºã€æå€¼éƒ½è¦æµ‹è¯•
4. **é•¿æ—¶é—´è¿è¡Œæµ‹è¯•**: æ£€æµ‹å†…å­˜æ³„æ¼

---

*æœ¬æ–‡æ¡£ä¸ºTaskFlowInsightæ ¸å¿ƒæ•°æ®æ¨¡å‹çš„å¼€å‘ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«æ‰€æœ‰å…³é”®è®¾è®¡å†³ç­–å’Œå®ç°ç»†èŠ‚ã€‚*

**åˆ›å»ºæ—¥æœŸ**: 2025-01-06  
**ç‰ˆæœ¬**: v1.0.0  
**é€‚ç”¨èŒƒå›´**: DEV-001è‡³DEV-005å¼€å‘ä»»åŠ¡